# 負荷テストとは何か


「負荷テスト」という単語をそのまま素直に解釈したら、あるプログラムに負荷をかけてみること、
ぐらいの意味になるかもしれない。

あるサーバーに、100人の同時ユーザー相当の負荷を人工的に発生させてみて、
問題が起きなかったら、負荷テストという作業は、完了したと言えるのだろうか。

ぼくが考える負荷テストとは、まず(1)　あるプログラムにN人の負荷をかけたとき、
プログラムがどう動くか(メモリの消費量とかパケットの数とかCPUの消費時間とか)を定式化すること。

次に(2)、そこで計算したとおり動いてるかを調べることだ。

1の作業で行う定式化の中には、100人を超えるとこうなる。ということまで含まれる。
で、実際に2の作業でその計算を実際のハードウェアを用いて検証して、100人を越えたので、計算した通り止まったとか、輻輳が発生した。とかを確認する。

負荷テスト作業で最も重要な成果物は、100人の負荷に耐えたことではなく、この定式化の内容だ。

この定式化をすることにより、観測された負荷(メモリ消費、CPU時間消費、帯域消費、遅延の大きさなど)が、
なぜ発生しているのかがわかる。　

定式化とは、たとえばN人のときは、毎秒　C+8N*(N-1)パケットが送信される。とか、
およそ200+10*Nメガバイトのメモリが消費されている、というようなことだ。

この定式化を得るための手順は、サーバーについては以下の通り:

1. ユーザー1人分の負荷をかけてみる。全部のパケットをトレースし、メモリの内容を調べ、CPU時間を調べる。原因不明の通信や割り当て、システムコール呼び出しなどが起きてないか調べる。起きてないなら次へ。
2. ユーザーを2人にする。
3. ユーザーを3人にする。。。4人、5人と増やす。　パケットの量などをすべて測定して、原因不明なことがないか調べる。
4. ユーザーを増やして負荷を上げていく。
5. ある時点で、計算どおりではない観測結果が起きることがある。メモリ消費量が階段状に上がるとか、遅延が跳ねるとか。
6. この作業をしていく中で、与えられた物理環境では、ここまでの負荷に耐えられるはず、という見積もりが可能になる。
7. 実際に、見積もり通り止まるかエラーになることを確認する。

ここまでやれば、その負荷がなぜ発生しているかが説明可能になる。
観測された負荷の理由をわかることは、プログラムがどんなふうに動いているかを知ることだ。
逆に言うと、どんなふうに動いてるかわからないプログラムをいくら100人のテストをしても、
どうやって動いてるかわからないのだから、あとで実際に100人の負荷がかかったら、
やっぱり動かなかった、という結果になるのは見えているのだ。


## 負荷テストの作業に必要なこと

以上のことから、負荷テストに必要なのは、
サーバープログラムを起動して、負荷発生装置を起動して、目視でエラーログが出るかどうか見るというだけではなく、
パケット数やマシンの負荷について観測するためのツールを使うことも必要だ。

サーバープロセスについては、Linuxならtcpdumpを用いてパケットをキャプチャして保存すること。
WindowsやMacなら Wiresharkを用いてキャプチャをすること。
またそれを解析することが必要になる。

また、マシンやネットワークの性能を把握するために、iperf3を使って、最大パケット数を計測したり、
topやsarコマンドを用いてCPUを測定したり, netstat -sを用いてエラーパケットを数えたりといった作業も必要になる。

負荷テストの作業をする人はこのあたりのツールを使える状態にする必要がある。