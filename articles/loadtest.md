# 負荷テストにおける仮説と検証

負荷テストをするときは、仮説をたててから検証をする必要がある。
仮説を立てずに検証をしても、検証結果の意味はほとんどない。
仮説なしでのテスト合格は、「運が良かっただけ」と区別がつけられないから。


## 検証作業

あるサーバーに、1000人の同時ユーザー相当の負荷を人工的に発生させてみたら、問題は発生しなかった。

という作業は、負荷テストの検証にあたる作業である。

負荷テストにおける仮説とは、

あるサーバーは、ユーザー1人あたり1000パケット毎秒のネットワーク負荷を発生させる。
AWSの与えられたマシンで送信可能なパケットは毎秒100万個までなので、
このサーバープロセスに1000人分以上の負荷をかけたら、ネットワークの輻輳が発生するので、接続が切断される。
ただしマシンのCPUとメモリについては、十分に余裕があるはずである。

というような見通しのことだ。

負荷テストの検証は、この見通しが正しいかどうかを検証する作業である。

## 仮説を見つけ出す方法

負荷テストの仮説は、最初は明確には存在しない。
プログラムを実装したプログラマーの頭のなかにぼんやりとしたイメージがあり、
それはだいたい楽観的な見通しになっているので、多くの場合間違えている。
なので、その間違いを見つけて改善につながるような仮説を見つけ出す必要がある。

仮説は考え出すものではなく、見つけるものだ。

負荷テストの仮説を見つけるためには、サーバーの負荷を0から少しづつ増やしていって、
それがプログラムの仕様から期待される動きに一致しているかどうかを調べていく。

まず、負荷がまったくない場合。サーバーが無駄なパケットを送信してるかもしれないし、
無駄な処理をしているためCPUを消費してるかもしれない。
プログラマは、負荷がないときは本当に負荷がないと思っているものだが、
意外と、負荷がないのに無駄なことをやっているプログラムは多いものだ。
問題を見つけたら直そう。

次に、負荷の最低単位、たとえばリアルタイムサーバーなら、同時接続数を1にして様子をみる。
同時接続数が1のときは、送信しているパケットの全部をキャプチャーできるだろう。
全部キャプチャーして、不要なことをやっていないか、サービスのために必要なこと以外の、
バグや明らかな無駄がないかを調べよう。

次に、同時接続数を2に増やす。
同時接続数が1から2に増えるタイミング、2から3に増えるタイミングとか、数が少ない時は、
正比例ではない増え方をすることも多いだろう。
パケット数やメモリ量が異常な増え方をしていないか確認しよう。逆に、負荷を増やしたら
パケットが減った、とかもあるかもしれない。何のためかがわからないパケットをなくす。

同時接続を5とか10ぐらいまで増やすと、曲線を描くことができる。
なぜか120人と130人の間で、曲線じゃなくて階段になってしまう、といったようなことはよくある。
調べたら、何かの配列が128で固定長になっていた、などといったことがわかるだろう。
その曲線が、プログラマの意図どおりになっているか確認する。

パケット数やCPU消費について、計算量のオーダーなどから、だいたいこのような曲線で伸びるだろう、
ということがアルゴリズムから予測でき、だいたいそれと一致していることがわかったら、
このマシン環境だとどのあたりで限界になるかが予測できる。

プログラムがどう動くか(メモリの消費量とかパケットの数とかCPUの消費時間とか)を定式化できたということである。

負荷テストの仮説とは、この定式化の内容だ。

定式化すると、たとえば同時接続がN人のときは、毎秒　C+8N*(N-1)パケットが送信される。とか、
およそ200+10*Nメガバイトのメモリが消費されている、というような表現が可能だ。
このような量の資源を消費するのは正しいのかどうか、プログラマと一緒に考えて確認する。


ここまでの作業で、仮説が得られたら、実は、負荷テストの仮説を検証する部分の作業も、ほとんど終わっているはずである。

## 負荷テストに必要な技術やスキル

負荷テストの仮説を立てるためには、
サーバープログラムを起動して、負荷発生装置を起動して、目視でエラーログが出るかどうか見るというだけでは足りない。
パケット数やマシンの負荷について観測するためのツールを使えることが必要だ。

サーバープロセスについては、Linuxならtcpdumpを用いてパケットをキャプチャして保存すること。
WindowsやMacなら Wiresharkを用いてキャプチャをすること。
またそれを解析することが必要になる。

また、マシンやネットワークの性能を把握するために、iperf3を使って、最大パケット数を計測したり、
topやsarコマンドを用いてCPUを測定したり, netstat -sを用いてエラーパケットを数えたりといった作業も必要になる。
straceやdtrace、Unityのプロファイラ、gprofなどいろいろなツールを使って、
プログラムが消費する資源を測定し、それが仕様に合っているかを確認しなければならない。

負荷テストの作業をする人はこのあたりのツールを使える状態にする必要がある。
